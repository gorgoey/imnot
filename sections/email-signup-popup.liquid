{% comment %}
  Email signup popup section – imnotamorningperson
{% endcomment %}

{%- if section.settings.enable_popup -%}
  <div
    id="EmailSignupPopup-{{ section.id }}"
    class="email-popup-overlay"
    aria-hidden="true"
  >
    <div class="email-popup-box">
      <button
        type="button"
        class="email-popup-close"
        aria-label="Close popup"
      >
        &times;
      </button>

      <div class="email-popup-row">
          {%- if section.settings.image != blank -%}
              <div class="email-popup-image">
              {{ section.settings.image | image_url: width: 900 | image_tag: loading: 'lazy' }}
              </div>
          {%- endif -%}
          <div class="email-popup-content">
              <div class="email-popup-content-body">                
                  <h2 class="email-popup-heading">
                    {{ section.settings.heading }}
                  </h2>
                  {%- if section.settings.subheading != blank -%}
                    <p class="email-popup-subheading">
                        {{ section.settings.subheading }}
                    </p>
                  {%- endif -%}
                  {%- form 'customer', id: 'EmailPopupForm-{{ section.id }}', class: 'email-popup-form newsletter-form' -%}
                      <input type="hidden" name="contact[tags]" value="newsletter">
          
                      <div class="newsletter-form__field-wrapper">
                          <div class="field email-popup-field">
                          <input
                              id="EmailPopupEmail-{{ section.id }}"
                              type="email"
                              name="contact[email]"
                              class="field__input email-popup-input"
                              value="{{ form.email }}"
                              aria-required="true"
                              autocorrect="off"
                              autocapitalize="off"
                              autocomplete="email"
                              {% if form.errors %}
                              autofocus
                              aria-invalid="true"
                              aria-describedby="EmailPopup-error-{{ section.id }}"
                              {% elsif form.posted_successfully? %}
                              aria-describedby="EmailPopup-success-{{ section.id }}"
                              {% endif %}
                              placeholder="{{ section.settings.email_placeholder }}"
                              required
                          >
              
                          <button
                              type="submit"
                              class="newsletter-form__button field__button email-popup-button"
                              name="commit"
                              aria-label="{{ 'newsletter.button_label' | t }}"
                          >
                              {% render 'icon-arrow' %}
                          </button>
                          </div>
              
                          {%- if form.errors -%}
                          <small
                              class="newsletter-form__message form__message email-popup-message"
                              id="EmailPopup-error-{{ section.id }}"
                          >
                              {% render 'icon-error' %}
                              {{ form.errors.translated_fields['email'] | capitalize }}
                              {{ form.errors.messages['email'] }}
                          </small>
                          {%- endif -%}
                      </div>
          
                      {%- if form.posted_successfully? -%}
                          <p
                          class="newsletter-form__message newsletter-form__message--success form__message email-popup-message email-popup-message--success"
                          id="EmailPopup-success-{{ section.id }}"
                          tabindex="-1"
                          autofocus
                          >
                          {% render 'icon-success' %}
                          {{ section.settings.success_message }}
                          </p>
                      {%- endif -%}
                  {%- endform -%}
              </div>
    
              <div class="email-popup-footer">
                  <div class="email-popup-brand">
                    <img src="https://imnotamorningperson.store/cdn/shop/files/imnot-white-ratio.png" width="150" height="30" />
                  </div>
              </div>
          </div>
      </div>
    </div>
  </div>

  <style>
    .email-popup-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .email-popup-overlay.is-visible {
      display: flex;
    }

    .email-popup-row {
        display: flex;
    }

    .email-popup-image {
        max-width: 50%;
    }

    .email-popup-box {
      position: relative;
      background: #000;
      color: #fff;
      border-radius: 24px;
      max-width: 720px;
      width: 100%;
      margin: 1.5rem;
      overflow: hidden;
    }

    .email-popup-heading {
        color: #fff;
        font-weight: 800;
    }

    .email-popup-image img {
      display: block;
      width: 100%;
      height: auto;
    }

    .email-popup-content {
      display: flex;
      flex-wrap: wrap;
      flex-direction: column;
      justify-content: space-between;
      padding-top: 2.5rem;
      padding-left: 1rem;
      padding-right: 1rem;
      padding-bottom: 1rem;
    }

    .email-popup-footer {
        margin-left: auto;
        text-align: right;
    }

    .email-popup-heading {
      margin: 1.25em 0 1.25rem;
      font-size: 3rem;
      line-height: 1.1;
      text-transform: uppercase;
      font-weight: bold;
    }

    .email-popup-subheading {
      margin: 0 0 1.75rem;
      font-size: 1.25rem;
      line-height: 1.75;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .email-popup-field {
      border: 1px solid #fff;
      padding: 0 0.75rem;
    }

    .email-popup-form {
        margin-top: 2em;
    }

    .email-popup-input {
      background: transparent;
      border: 0;
      color: #fff;
      padding: 0.5rem 0;
      font-size: 0.9rem;
    }

    .email-popup-input::placeholder {
      color: #fff;
      opacity: 0.6;
    }

    .email-popup-button {
      background: transparent;
      border: 0;
      cursor: pointer;
    }

    .email-popup-close {
      position: absolute;
      top: 1rem;
      right: 1.25rem;
      background: none;
      border: 0;
      color: #fff;
      font-size: 1.6rem;
      line-height: 1;
      cursor: pointer;
    }

    .email-popup-brand {
      margin-top: 1.75rem;
      font-size: 0.65rem;
      text-align: right;
      letter-spacing: 0.18em;
      text-transform: uppercase;
    }

    @media screen and (max-width: 600px) {
      .email-popup-content {
        padding: 1.75rem 1.5rem 1.25rem;
      }

      .email-popup-heading {
        font-size: 1.6rem;
      }
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var popup = document.getElementById('EmailSignupPopup-{{ section.id }}');
      if (!popup) return;

      // ถ้าเคยปิดไปแล้ว ไม่ต้องโชว์อีก
      if (window.localStorage && localStorage.getItem('imnot_email_popup_closed') === 'true') {
        return;
      }

      var delay = {{ section.settings.delay_seconds | default: 3 | times: 1000 }};

      setTimeout(function () {
        popup.classList.add('is-visible');
        popup.setAttribute('aria-hidden', 'false');
      }, delay);

      popup.addEventListener('click', function (e) {
        if (e.target === popup || e.target.closest('.email-popup-close')) {
          popup.classList.remove('is-visible');
          popup.setAttribute('aria-hidden', 'true');
          if (window.localStorage) {
            localStorage.setItem('imnot_email_popup_closed', 'true');
          }
        }
      });
    });
  </script>
{%- endif -%}

{% schema %}
{
  "name": "Email signup popup",
  "settings": [
    {
      "type": "checkbox",
      "id": "enable_popup",
      "label": "Enable popup",
      "default": true
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "STILL WAKING UP? HERE\u2019S 10% OFF"
    },
    {
      "type": "textarea",
      "id": "subheading",
      "label": "Subheading",
      "default": "JOIN OUR EMAIL LIST AND UNLOCK YOUR 10% OFF CODE. STAY AHEAD ON NEW COLLECTIONS, EXCLUSIVE RELEASES, AND EARLY-ACCESS DEALS FROM IMNOTAMORNINGPERSON.COM"
    },
    {
      "type": "image_picker",
      "id": "image",
      "label": "Top image (mobile / optional)"
    },
    {
      "type": "text",
      "id": "email_placeholder",
      "label": "Email placeholder",
      "default": "E-mail Address"
    },
    {
      "type": "text",
      "id": "success_message",
      "label": "Success message",
      "default": "You\u2019re in. Check your inbox for your 10% off code."
    },
    {
      "type": "number",
      "id": "delay_seconds",
      "label": "Show after (seconds)",
      "default": 3
    }
  ],
  "presets": [
    {
      "name": "Email signup popup"
    }
  ]
}
{% endschema %}
